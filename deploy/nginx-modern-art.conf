# Modern Art Game Server - Nginx Configuration
# 既存の elefolo2.com サーバーブロック (HTTPS 443) 内に include して使用
#
# 使い方:
#   既存の server { listen 443 ssl; ... } ブロック内に以下を追加:
#     include /etc/nginx/conf.d/modern-art.conf;
#
#   または、このファイルの内容を既存の server ブロック内に直接コピー

# --- 静的ファイル配信 (/games/modern-art/) ---
location /games/modern-art/ {
    alias /opt/modern-art/export/;
    index index.html;

    # Godot WASM に必要な COOP/COEP ヘッダ (SharedArrayBuffer 対応)
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Cache-Control "no-cache, must-revalidate";
}

# --- WebSocket リバースプロキシ (/games/modern-art/ws) ---
location /games/modern-art/ws {
    proxy_pass http://127.0.0.1:8080/ws;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket タイムアウト (ゲーム中の長時間接続対応)
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
}
